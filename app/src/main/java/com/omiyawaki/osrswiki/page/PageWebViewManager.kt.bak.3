package com.omiyawaki.osrswiki.page

import android.annotation.SuppressLint
import android.graphics.Color
import android.util.Log
import android.webkit.ConsoleMessage
import android.webkit.WebChromeClient
import android.webkit.WebView
import com.omiyawaki.osrswiki.dataclient.WikiSite
import com.omiyawaki.osrswiki.theme.Theme

/**
 * Manages the configuration and rendering of content within the WebView.
 * It now loads a pre-constructed HTML document and applies dynamic theming.
 */
class PageWebViewManager(
    private val webView: WebView,
    private val linkHandler: PageLinkHandler,
    private val onPageReady: () -> Unit
) {
    private val webViewDebugTag = "WebViewConsole"
    private var currentTheme: Theme = Theme.DEFAULT_LIGHT

    init {
        setupWebView()
    }

    @SuppressLint("SetJavaScriptEnabled")
    private fun setupWebView() {
        webView.webViewClient = object : AppWebViewClient(linkHandler) {
            override fun onPageFinished(view: WebView?, url: String?) {
                super.onPageFinished(view, url)
                // When the initial HTML has been loaded, apply our dynamic theme and reveal the body.
                applyStylingAndRevealBody()
            }
        }
        webView.webChromeClient = object : WebChromeClient() {
            override fun onConsoleMessage(consoleMessage: ConsoleMessage?): Boolean {
                consoleMessage?.let {
                    val message = "[${it.sourceId()}:${it.lineNumber()}] ${it.message()}"
                    when (it.messageLevel()) {
                        ConsoleMessage.MessageLevel.ERROR -> Log.e(webViewDebugTag, message)
                        ConsoleMessage.MessageLevel.WARNING -> Log.w(webViewDebugTag, message)
                        else -> Log.i(webViewDebugTag, message)
                    }
                }
                return true
            }
        }
        webView.settings.javaScriptEnabled = true
        // Set a transparent background to prevent a white flash before the page loads.
        // The actual background color will be set by the loaded HTML/CSS.
        webView.setBackgroundColor(Color.TRANSPARENT)
    }

    /**
     * Renders a fully pre-constructed HTML document in the WebView.
     *
     * @param fullHtml The complete HTML document string (including scripts and styles).
     * @param baseUrl The base URL for resolving relative paths.
     * @param theme The theme to apply to the content.
     */
    fun render(fullHtml: String, baseUrl: String?, theme: Theme) {
        this.currentTheme = theme
        val finalBaseUrl = baseUrl ?: WikiSite.OSRS_WIKI.url()
        webView.loadDataWithBaseURL(finalBaseUrl, fullHtml, "text/html", "UTF-8", null)
    }

    /**
     * Applies the specific theme class to the body and makes it visible.
     * This is called from onPageFinished to prevent a Flash of Unstyled Content (FOUC).
     */
    private fun applyStylingAndRevealBody() {
        val themeClass = when (currentTheme) {
            Theme.OSRS_DARK -> "theme-osrs-dark"
            Theme.WIKI_LIGHT -> "theme-wikipedia-light"
            Theme.WIKI_DARK -> "theme-wikipedia-dark"
            Theme.WIKI_BLACK -> "theme-wikipedia-black"
            else -> "" // OSRS_LIGHT uses the :root default, no class needed.
        }

        val applyThemeAndRevealBodyJs = """
            (function() {
                if (!document.body) return;
                // Remove all possible theme classes to ensure a clean slate.
                document.body.classList.remove(
                    'theme-wikipedia-light',
                    'theme-osrs-dark',
                    'theme-wikipedia-dark',
                    'theme-wikipedia-black'
                );
                // Add the new, specific theme class if it's not the default.
                if ('$themeClass') {
                    document.body.classList.add('$themeClass');
                }
                // Finally, make the body visible.
                document.body.style.visibility = 'visible';
            })();
        """.trimIndent()

        webView.evaluateJavascript(applyThemeAndRevealBodyJs) {
            // After revealing the body, we signal that the page is ready.
            onPageReady()
        }
    }
}
