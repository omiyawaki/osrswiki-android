<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>OSRS World Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100%; background-color: #0b0b0b; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    var map;

    function initializeMap(tileBaseUrl) {
        console.log("Initializing map with base URL: " + tileBaseUrl);

        const conversionFactor = 256.0;
        const contentWidth = 12800;
        const contentHeight = 45568;

        const boundsY = contentHeight / conversionFactor;
        const boundsX = contentWidth / conversionFactor;
        const contentMaxBounds = [[0, 0], [boundsY, boundsX]];

        const TopDownCRS = L.Util.extend({}, L.CRS.Simple, {
            transformation: new L.Transformation(1, 0, 1, 0)
        });

        map = L.map('map', {
            crs: TopDownCRS,
            minZoom: 0,
            maxZoom: 8,
            maxBounds: contentMaxBounds
        });

        const tileUrl = tileBaseUrl + '{z}/{x}/{y}.png';
        console.log("Using tile URL template: " + tileUrl);

        L.tileLayer(tileUrl, {
            attribution: 'OSRS Wiki',
            tms: false,
            noWrap: true,
            bounds: [[0, 0], [256, 256]]
        }).addTo(map);

        map.setView([boundsY / 2, boundsX / 2], 1);
    }

    function loadPois(jsonData) {
        if (!map) {
            console.error("Map is not initialized. Cannot load POIs.");
            return;
        }
        try {
            const MIN_X_OFFSET = 1024;
            const MAX_Y_OFFSET = 12608;
            const PIXELS_PER_TILE = 4;
            const conversionFactor = 256.0;

            const pois = JSON.parse(jsonData);
            const markers = L.markerClusterGroup();

            pois.forEach(poi => {
                if (poi.plane === 0) {
                    // Step 1: Apply the RuneLite formula to get the base pixel coordinate.
                    let x_image = (poi.x - MIN_X_OFFSET) * PIXELS_PER_TILE;
                    let y_image = (MAX_Y_OFFSET - poi.y) * PIXELS_PER_TILE;

                    // Step 2: Apply final calibration based on visual feedback.
                    // +4 pixels to move one tile to the right.
                    // -4 pixels to move one tile up.
                    x_image += PIXELS_PER_TILE;
                    y_image -= PIXELS_PER_TILE;

                    // Step 3: Scale the final pixel coordinate for Leaflet.
                    const x_leaflet = x_image / conversionFactor;
                    const y_leaflet = y_image / conversionFactor;

                    const marker = L.marker([y_leaflet, x_leaflet]);
                    marker.bindPopup(`<b>${poi.name}</b><br>Game: [${poi.y}, ${poi.x}]`);
                    markers.addLayer(marker);
                }
            });
            map.addLayer(markers);
            console.log("Marker cluster layer added with final calibration.");
        } catch (e) {
            console.error("ERROR in loadPois(): ", e);
        }
    }
</script>
</body>
</html>
